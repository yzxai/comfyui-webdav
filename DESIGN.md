# ComfyUI WebDAV Node - 设计文档

## 1. 项目概述

本项目旨在为ComfyUI创建一个自定义节点，允许用户将生成的图像直接上传到WebDAV服务器，而无需将其保存到本地磁盘。该节点将提供灵活的配置选项，包括服务器地址、认证信息和路径设置。

## 2. 功能需求

### 2.1 核心功能
- 将生成的图像直接上传到WebDAV服务器
- 支持JPEG和PNG格式的图像
- 不在本地磁盘保存图像文件

### 2.2 配置选项
- WebDAV服务器URL
- 用户名和密码认证
- 远程路径设置
- SSL证书验证选项（可跳过自签名证书）

### 2.3 预览功能
- 图像预览显示（主要用于文生图场景）
- 可选支持其他类型预览（如视频）

## 3. 技术架构

### 3.1 ComfyUI节点结构
- 继承自ComfyUI的基础节点类
- 实现必要的输入/输出接口
- 遵循ComfyUI节点命名规范

### 3.2 WebDAV集成
- 使用Python的`webdav4`库实现WebDAV协议
- 实现文件上传功能
- 处理认证和SSL验证

### 3.3 配置管理
- 节点参数配置
- 错误处理和日志记录

## 4. 节点设计

### 4.1 输入参数
- `images`: 输入的图像数据（ComfyUI图像格式）
- `server_url`: WebDAV服务器URL
- `username`: 用户名
- `password`: 密码
- `remote_path`: 远程路径
- `skip_ssl_verify`: 是否跳过SSL验证（布尔值）

### 4.2 文件命名规则
- 文件名格式：`comfyui_{timestamp}_{uuid}.png`
- timestamp：毫秒级时间戳，确保时间唯一性
- uuid：缩短的UUID，确保全局唯一性
- 通过time+uuid的组合，确保文件名的绝对唯一性，避免上传冲突

### 4.2 输出参数
- `images`: 输出的图像数据（用于预览）
- `status`: 上传状态信息

### 4.3 节点类别
- 分类：`image/postprocessing` 或 `utils`

## 5. 实现计划

### 5.1 依赖库
- `webdav4>=0.9` 用于WebDAV通信
- `Pillow` 用于图像处理（如果需要）

### 5.2 错误处理
- 网络连接错误
- 认证失败
- 上传失败
- SSL证书错误

### 5.3 安全考虑
- 密码安全存储（在节点配置中）
- SSL验证选项

## 6. 测试方案

### 6.1 单元测试
- WebDAV连接测试
- 图像上传测试
- 配置参数验证

### 6.2 集成测试
- 在ComfyUI中测试节点功能
- 验证不同配置下的行为

## 7. 部署说明

### 7.1 安装步骤
1. 将项目文件复制到ComfyUI的`custom_nodes`目录
2. 安装必要的依赖库
3. 重启ComfyUI

### 7.2 使用方法
1. 在节点浏览器中找到WebDAV节点
2. 配置服务器参数
3. 连接图像输入
4. 执行工作流

## 8. 未来扩展

### 8.1 可选功能
- 批量上传支持
- 文件名自定义
- 上传进度显示
- 视频文件支持

### 8.2 性能优化
- 异步上传
- 上传队列管理

## 9. 隐私保护扩展

### 9.1 隐私保护节点
为了应对用户在图生图场景中对隐私保护的需求，我们扩展了功能，添加了隐私保护节点：
- 防止图像保存到本地磁盘
- 在内存中处理图像
- 与WebDAV上传节点配合使用

### 9.2 工作流程
1. 用户上传图像到图生图节点
2. 图像通过隐私保护节点处理
3. 图像直接传递给WebDAV上传节点
4. 图像上传到WebDAV服务器，不保存在本地